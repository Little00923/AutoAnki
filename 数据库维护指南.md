# ğŸ—„ï¸ AutoAnki æ•°æ®åº“ç»´æŠ¤æŒ‡å—

## ğŸ“Œ é‡è¦è¯´æ˜

### âœ… SQLite æ•°æ®åº“ç‰¹ç‚¹
- **æ— éœ€è´¦å·å¯†ç **ï¼šSQLite æ˜¯æ–‡ä»¶å‹æ•°æ®åº“ï¼Œç›´æ¥è®¿é—®æ–‡ä»¶å³å¯
- **æ•°æ®åº“ä½ç½®**ï¼š`database/autoanki.db`
- **è®¿é—®æƒé™**ï¼šæ‹¥æœ‰æ–‡ä»¶è¯»å†™æƒé™å³å¯æ“ä½œ

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹æ³•1: ä½¿ç”¨æ•°æ®åº“ç®¡ç†è„šæœ¬ï¼ˆæœ€ç®€å•ï¼‰

```bash
# è¿›å…¥äº¤äº’å¼èœå•
./db_manager.sh

# æˆ–ç›´æ¥æ‰§è¡Œç‰¹å®šå‘½ä»¤
./db_manager.sh users    # æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·
./db_manager.sh stats    # æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
./db_manager.sh config   # æŸ¥çœ‹ç³»ç»Ÿé…ç½®
./db_manager.sh backup   # å¤‡ä»½æ•°æ®åº“
```

#### è„šæœ¬åŠŸèƒ½èœå•
```
1)  æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·              - åˆ—å‡ºæ‰€æœ‰æ³¨å†Œç”¨æˆ·
2)  æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…              - æŸ¥çœ‹ç”¨æˆ·ç§¯åˆ†ã€è¯•ç”¨è®°å½•
3)  ç»™ç”¨æˆ·å……å€¼ç§¯åˆ†            - æ‰‹åŠ¨ä¸ºç”¨æˆ·å……å€¼
4)  é‡ç½®ç”¨æˆ·è¯•ç”¨é¢åº¦          - é‡ç½®è¯•ç”¨æ¬¡æ•°
5)  æŸ¥çœ‹ç§¯åˆ†äº¤æ˜“è®°å½•          - æŸ¥çœ‹å……å€¼/æ¶ˆè´¹è®°å½•
6)  æŸ¥çœ‹è®¢å•è®°å½•              - æŸ¥çœ‹æ”¯ä»˜è®¢å•
7)  æŸ¥çœ‹ç³»ç»Ÿé…ç½®              - æŸ¥çœ‹æ‰€æœ‰é…ç½®é¡¹
8)  ä¿®æ”¹ç³»ç»Ÿé…ç½®              - ä¿®æ”¹é…ç½®å€¼
9)  æŸ¥çœ‹æ•°æ®åº“ç»Ÿè®¡            - ç”¨æˆ·ã€å¡ç‰‡ç»Ÿè®¡
10) å¤‡ä»½æ•°æ®åº“                - å¤‡ä»½åˆ° backups/ ç›®å½•
11) ä¼˜åŒ–æ•°æ®åº“                - æ¸…ç†ç¢ç‰‡ï¼Œä¼˜åŒ–æ€§èƒ½
12) è¿›å…¥ SQLite æ§åˆ¶å°        - ç›´æ¥æ“ä½œæ•°æ®åº“
```

---

### æ–¹æ³•2: ä½¿ç”¨ SQLite å‘½ä»¤è¡Œï¼ˆçµæ´»ï¼‰

#### åŸºç¡€æ“ä½œ

```bash
# è¿›å…¥æ•°æ®åº“
sqlite3 database/autoanki.db

# è®¾ç½®æ˜¾ç¤ºæ ¼å¼
.mode column
.headers on

# æŸ¥çœ‹æ‰€æœ‰è¡¨
.tables

# æŸ¥çœ‹è¡¨ç»“æ„
.schema users

# é€€å‡º
.quit
```

#### å¸¸ç”¨æŸ¥è¯¢

**æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·**
```sql
SELECT id, username, email, credits, free_cards_used 
FROM users;
```

**æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…**
```sql
SELECT * FROM users WHERE username = 'L';
```

**æŸ¥çœ‹ç§¯åˆ†äº¤æ˜“è®°å½•**
```sql
SELECT 
    u.username,
    ct.type,
    ct.amount,
    ct.description,
    datetime(ct.created_at, 'localtime') as time
FROM credit_transactions ct
JOIN users u ON ct.user_id = u.id
ORDER BY ct.created_at DESC
LIMIT 20;
```

**æŸ¥çœ‹å¡ç‰‡ç”Ÿæˆè®°å½•**
```sql
SELECT 
    u.username,
    cg.card_count,
    cg.credits_used,
    cg.is_trial,
    datetime(cg.created_at, 'localtime') as time
FROM card_generations cg
LEFT JOIN users u ON cg.user_id = u.id
ORDER BY cg.created_at DESC
LIMIT 20;
```

---

### æ–¹æ³•3: ä½¿ç”¨å›¾å½¢ç•Œé¢å·¥å…·ï¼ˆæ¨èåˆå­¦è€…ï¼‰

#### 1. DB Browser for SQLiteï¼ˆå…è´¹ï¼‰

**å®‰è£…**
```bash
# Ubuntu/Debian
sudo apt install sqlitebrowser

# macOS
brew install --cask db-browser-for-sqlite

# Windows
# ä»å®˜ç½‘ä¸‹è½½ï¼šhttps://sqlitebrowser.org/
```

**ä½¿ç”¨æ­¥éª¤**
1. æ‰“å¼€ DB Browser for SQLite
2. ç‚¹å‡» "Open Database"
3. é€‰æ‹© `database/autoanki.db`
4. å¯è§†åŒ–æŸ¥çœ‹å’Œç¼–è¾‘æ•°æ®

#### 2. VSCode æ‰©å±•

åœ¨ VSCode ä¸­å®‰è£… `SQLite Viewer` æ‰©å±•ï¼š
- å³é”®ç‚¹å‡» `autoanki.db` æ–‡ä»¶
- é€‰æ‹© "Open Database"
- å¯è§†åŒ–æµè§ˆæ•°æ®

---

## ğŸ“‹ å¸¸è§ç»´æŠ¤ä»»åŠ¡

### 1. ç»™ç”¨æˆ·å……å€¼ç§¯åˆ†

#### æ–¹æ³•A: ä½¿ç”¨è„šæœ¬
```bash
./db_manager.sh
# é€‰æ‹© 3) ç»™ç”¨æˆ·å……å€¼ç§¯åˆ†
# æŒ‰æç¤ºè¾“å…¥ä¿¡æ¯
```

#### æ–¹æ³•B: ä½¿ç”¨ SQL
```bash
sqlite3 database/autoanki.db << 'EOF'
BEGIN TRANSACTION;

-- ç»™ç”¨æˆ· L å……å€¼ 1000 ç§¯åˆ†
UPDATE users 
SET credits = credits + 1000 
WHERE username = 'L';

-- è®°å½•äº¤æ˜“
INSERT INTO credit_transactions (user_id, amount, type, description, balance_after)
SELECT id, 1000, 'recharge', 'ç®¡ç†å‘˜æ‰‹åŠ¨å……å€¼', credits
FROM users 
WHERE username = 'L';

COMMIT;
EOF
```

**éªŒè¯å……å€¼**
```bash
sqlite3 -column -header database/autoanki.db \
  "SELECT username, credits FROM users WHERE username = 'L';"
```

---

### 2. ä¿®æ”¹ç³»ç»Ÿé…ç½®

#### æŸ¥çœ‹å½“å‰é…ç½®
```bash
./db_manager.sh config
```

#### ä¿®æ”¹é…ç½®å€¼
```sql
-- ä¿®æ”¹æ¯å¼ å¡ç‰‡æ¶ˆè€—ç§¯åˆ†ï¼ˆé»˜è®¤15ï¼‰
UPDATE system_config 
SET value = '20' 
WHERE key = 'credits_per_card';

-- ä¿®æ”¹è¯•ç”¨æ¬¡æ•°ï¼ˆé»˜è®¤3æ¬¡ï¼‰
UPDATE system_config 
SET value = '5' 
WHERE key = 'free_trial_times';

-- ä¿®æ”¹æ¯æ¬¡è¯•ç”¨å¡ç‰‡æ•°ï¼ˆé»˜è®¤2å¼ ï¼‰
UPDATE system_config 
SET value = '3' 
WHERE key = 'free_trial_cards_per_time';

-- ä¿®æ”¹æ–°ç”¨æˆ·èµ é€ç§¯åˆ†ï¼ˆé»˜è®¤300ï¼‰
UPDATE system_config 
SET value = '500' 
WHERE key = 'new_user_gift_credits';

-- ä¿®æ”¹å……å€¼æ±‡ç‡ï¼ˆé»˜è®¤1å…ƒ=100ç§¯åˆ†ï¼‰
UPDATE system_config 
SET value = '150' 
WHERE key = 'recharge_rate';
```

---

### 3. é‡ç½®ç”¨æˆ·è¯•ç”¨é¢åº¦

```bash
# é‡ç½®ç‰¹å®šç”¨æˆ·
sqlite3 database/autoanki.db \
  "UPDATE users SET free_cards_used = 0 WHERE username = 'L';"

# é‡ç½®æ‰€æœ‰ç”¨æˆ·
sqlite3 database/autoanki.db \
  "UPDATE users SET free_cards_used = 0;"
```

---

### 4. æŸ¥çœ‹æ•°æ®åº“ç»Ÿè®¡

```bash
./db_manager.sh stats
```

æˆ–æ‰‹åŠ¨æŸ¥è¯¢ï¼š

```sql
-- ç”¨æˆ·ç»Ÿè®¡
SELECT 
    COUNT(*) as total_users,
    SUM(credits) as total_credits,
    AVG(credits) as avg_credits
FROM users;

-- ä»Šæ—¥æ´»è·ƒç”¨æˆ·
SELECT COUNT(DISTINCT user_id) as active_users
FROM card_generations
WHERE date(created_at) = date('now');

-- æœ¬æœˆå……å€¼ç»Ÿè®¡
SELECT 
    COUNT(*) as order_count,
    SUM(amount) as total_amount
FROM orders
WHERE status = 'paid' 
  AND strftime('%Y-%m', created_at) = strftime('%Y-%m', 'now');
```

---

### 5. å¤‡ä»½æ•°æ®åº“

#### è‡ªåŠ¨å¤‡ä»½ï¼ˆæ¨èï¼‰
```bash
./db_manager.sh backup
```

#### æ‰‹åŠ¨å¤‡ä»½
```bash
# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p backups

# å¤‡ä»½æ•°æ®åº“
cp database/autoanki.db backups/autoanki_$(date +%Y%m%d_%H%M%S).db

# å‹ç¼©å¤‡ä»½
gzip backups/autoanki_*.db
```

#### æ¢å¤å¤‡ä»½
```bash
# è§£å‹å¤‡ä»½æ–‡ä»¶
gunzip backups/autoanki_20251016_120000.db.gz

# åœæ­¢æœåŠ¡å™¨
pkill -f "node server.js"

# æ¢å¤æ•°æ®åº“
cp backups/autoanki_20251016_120000.db database/autoanki.db

# é‡å¯æœåŠ¡å™¨
npm start
```

---

### 6. å®šæœŸç»´æŠ¤ä»»åŠ¡

#### æ¯å‘¨ä»»åŠ¡
```bash
# 1. å¤‡ä»½æ•°æ®åº“
./db_manager.sh backup

# 2. ä¼˜åŒ–æ•°æ®åº“
./db_manager.sh optimize
```

#### æ¯æœˆä»»åŠ¡
```bash
# æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘30å¤©ï¼‰
find backups/ -name "*.db.gz" -mtime +30 -delete

# æŸ¥çœ‹æ•°æ®åº“å¤§å°
du -h database/autoanki.db
```

---

## ğŸ”§ é«˜çº§æ“ä½œ

### å¯¼å‡ºæ•°æ®

#### å¯¼å‡ºä¸º CSV
```bash
sqlite3 -header -csv database/autoanki.db \
  "SELECT * FROM users;" > users_export.csv
```

#### å¯¼å‡ºä¸º SQL
```bash
sqlite3 database/autoanki.db .dump > database_backup.sql
```

### ä» SQL æ¢å¤
```bash
sqlite3 database/autoanki_new.db < database_backup.sql
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1: æ•°æ®åº“é”å®š
**é”™è¯¯**: `database is locked`

**åŸå› **: å¦ä¸€ä¸ªè¿›ç¨‹æ­£åœ¨ä½¿ç”¨æ•°æ®åº“

**è§£å†³**:
```bash
# æŸ¥çœ‹å ç”¨è¿›ç¨‹
lsof database/autoanki.db

# åœæ­¢æœåŠ¡å™¨
pkill -f "node server.js"

# é‡å¯æœåŠ¡å™¨
npm start
```

### é—®é¢˜2: æ•°æ®åº“æŸå
**é”™è¯¯**: `database disk image is malformed`

**è§£å†³**:
```bash
# å°è¯•ä¿®å¤
sqlite3 database/autoanki.db "PRAGMA integrity_check;"

# å¦‚æœæ— æ³•ä¿®å¤ï¼Œæ¢å¤å¤‡ä»½
cp backups/latest_backup.db database/autoanki.db
```

### é—®é¢˜3: ç”¨æˆ·ç§¯åˆ†ä¸æ­£ç¡®

**æ£€æŸ¥äº¤æ˜“è®°å½•**:
```sql
SELECT * FROM credit_transactions 
WHERE user_id = (SELECT id FROM users WHERE username = 'L')
ORDER BY created_at DESC;
```

**é‡æ–°è®¡ç®—ç§¯åˆ†**:
```sql
-- è®¡ç®—æ­£ç¡®çš„ç§¯åˆ†ä½™é¢
SELECT 
    u.username,
    u.credits as current_credits,
    COALESCE(SUM(CASE 
        WHEN ct.type = 'recharge' THEN ct.amount
        WHEN ct.type = 'consume' THEN -ct.amount
    END), 0) as calculated_credits
FROM users u
LEFT JOIN credit_transactions ct ON u.id = ct.user_id
WHERE u.username = 'L'
GROUP BY u.id;
```

---

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

### users (ç”¨æˆ·è¡¨)
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| id | INTEGER | ä¸»é”® |
| username | TEXT | ç”¨æˆ·åï¼ˆå”¯ä¸€ï¼‰ |
| email | TEXT | é‚®ç®±ï¼ˆå”¯ä¸€ï¼‰ |
| password | TEXT | å¯†ç å“ˆå¸Œ |
| credits | INTEGER | ç§¯åˆ†ä½™é¢ |
| free_cards_used | INTEGER | å·²ä½¿ç”¨è¯•ç”¨å¡ç‰‡æ•° |
| is_logged_in_trial_used | BOOLEAN | ç™»å½•è¯•ç”¨æ˜¯å¦å·²ä½¿ç”¨ |
| created_at | DATETIME | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | æ›´æ–°æ—¶é—´ |

### credit_transactions (ç§¯åˆ†äº¤æ˜“è¡¨)
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| id | INTEGER | ä¸»é”® |
| user_id | INTEGER | ç”¨æˆ·ID |
| amount | INTEGER | äº¤æ˜“é‡‘é¢ |
| type | TEXT | ç±»å‹ï¼šrecharge/consume |
| description | TEXT | äº¤æ˜“è¯´æ˜ |
| balance_after | INTEGER | äº¤æ˜“åä½™é¢ |
| created_at | DATETIME | åˆ›å»ºæ—¶é—´ |

### orders (è®¢å•è¡¨)
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| id | INTEGER | ä¸»é”® |
| order_no | TEXT | è®¢å•å·ï¼ˆå”¯ä¸€ï¼‰ |
| user_id | INTEGER | ç”¨æˆ·ID |
| amount | REAL | æ”¯ä»˜é‡‘é¢ï¼ˆå…ƒï¼‰ |
| credits | INTEGER | è´­ä¹°ç§¯åˆ†æ•° |
| payment_method | TEXT | æ”¯ä»˜æ–¹å¼ï¼šwechat/alipay |
| status | TEXT | çŠ¶æ€ï¼špending/paid/failed |
| created_at | DATETIME | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | æ›´æ–°æ—¶é—´ |

### card_generations (å¡ç‰‡ç”Ÿæˆè®°å½•è¡¨)
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| id | INTEGER | ä¸»é”® |
| user_id | INTEGER | ç”¨æˆ·IDï¼ˆå¯ä¸ºç©ºï¼‰ |
| session_id | TEXT | åŒ¿åä¼šè¯ID |
| card_count | INTEGER | ç”Ÿæˆå¡ç‰‡æ•° |
| credits_used | INTEGER | æ¶ˆè€—ç§¯åˆ†æ•° |
| is_trial | BOOLEAN | æ˜¯å¦ä¸ºè¯•ç”¨ |
| created_at | DATETIME | åˆ›å»ºæ—¶é—´ |

### system_config (ç³»ç»Ÿé…ç½®è¡¨)
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| key | TEXT | é…ç½®é”®ï¼ˆä¸»é”®ï¼‰ |
| value | TEXT | é…ç½®å€¼ |
| description | TEXT | é…ç½®è¯´æ˜ |
| created_at | DATETIME | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | æ›´æ–°æ—¶é—´ |

---

## ğŸ”’ å®‰å…¨å»ºè®®

1. **å®šæœŸå¤‡ä»½**
   ```bash
   # æ·»åŠ åˆ° crontabï¼ˆæ¯å¤©3ç‚¹å¤‡ä»½ï¼‰
   0 3 * * * cd /home/ling/coding/newAutoAnki && ./db_manager.sh backup
   ```

2. **è®¾ç½®æ–‡ä»¶æƒé™**
   ```bash
   chmod 600 database/autoanki.db  # ä»…æ‰€æœ‰è€…å¯è¯»å†™
   ```

3. **é™åˆ¶è®¿é—®**
   - ä¸è¦å°†æ•°æ®åº“æ–‡ä»¶æ”¾åœ¨ public ç›®å½•
   - ä¸è¦åœ¨ git ä¸­æäº¤æ•°æ®åº“æ–‡ä»¶ï¼ˆå·²åœ¨ .gitignore ä¸­é…ç½®ï¼‰

4. **åŠ å¯†å¤‡ä»½**
   ```bash
   # ä½¿ç”¨ GPG åŠ å¯†å¤‡ä»½
   gpg -c backups/autoanki_backup.db
   ```

---

## ğŸ“š æ›´å¤šèµ„æº

- SQLite å®˜æ–¹æ–‡æ¡£: https://www.sqlite.org/docs.html
- SQLite å‘½ä»¤é€ŸæŸ¥: https://www.sqlite.org/cli.html
- DB Browser: https://sqlitebrowser.org/

---

## âœ… ç»´æŠ¤æ£€æŸ¥æ¸…å•

### æ¯æ—¥
- [ ] æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯
- [ ] æŸ¥çœ‹ä»Šæ—¥ç”¨æˆ·æ´»è·ƒæƒ…å†µ

### æ¯å‘¨
- [ ] å¤‡ä»½æ•°æ®åº“
- [ ] ä¼˜åŒ–æ•°æ®åº“
- [ ] æŸ¥çœ‹æ•°æ®åº“ç»Ÿè®¡

### æ¯æœˆ
- [ ] æ¸…ç†æ—§å¤‡ä»½æ–‡ä»¶
- [ ] æ£€æŸ¥æ•°æ®åº“å®Œæ•´æ€§
- [ ] å®¡æŸ¥ç”¨æˆ·å¢é•¿æƒ…å†µ
- [ ] åˆ†æç§¯åˆ†æ¶ˆè´¹è¶‹åŠ¿

---

**æ•°æ®åº“ä½ç½®**: `database/autoanki.db`  
**ç®¡ç†å·¥å…·**: `./db_manager.sh`  
**å¤‡ä»½ç›®å½•**: `./backups/`


