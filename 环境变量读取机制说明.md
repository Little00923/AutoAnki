# ğŸ”§ ç¯å¢ƒå˜é‡è¯»å–æœºåˆ¶è¯¦è§£

## ğŸ“š å®Œæ•´æµç¨‹å›¾

```
.env æ–‡ä»¶ â†’ dotenv åŒ… â†’ process.env å¯¹è±¡ â†’ åº”ç”¨ä»£ç è¯»å–
   â†“            â†“              â†“                â†“
åŒ…å«é…ç½®    åŠ è½½åˆ°å†…å­˜    Node.js å…¨å±€å¯¹è±¡   ä½¿ç”¨é…ç½®
```

---

## 1ï¸âƒ£ æ­¥éª¤1ï¼šdotenv åŒ…åŠ è½½ .env æ–‡ä»¶

### ä»£ç ä½ç½®ï¼š`server.js` ç¬¬1è¡Œ

```javascript
require('dotenv').config();
```

### è¿™è¡Œä»£ç åšäº†ä»€ä¹ˆï¼Ÿ

1. **åŠ è½½ `dotenv` åŒ…**
2. **è°ƒç”¨ `.config()` æ–¹æ³•**
3. **è¯»å–é¡¹ç›®æ ¹ç›®å½•çš„ `.env` æ–‡ä»¶**
4. **è§£ææ–‡ä»¶å†…å®¹**
5. **å°†å˜é‡æ³¨å…¥åˆ° `process.env` å¯¹è±¡**

### è¯¦ç»†è¿‡ç¨‹

```javascript
// dotenv åŒ…å†…éƒ¨ä¼šè¿™æ ·åšï¼š
// 1. è¯»å– .env æ–‡ä»¶
const fs = require('fs');
const envContent = fs.readFileSync('.env', 'utf-8');

// 2. è§£ææ¯ä¸€è¡Œ
// PAYPAL_CLIENT_ID=AxxxxQ
// PAYPAL_SECRET=ExxxxQ

// 3. å°†å®ƒä»¬æ·»åŠ åˆ° process.env
process.env.PAYPAL_CLIENT_ID = 'AxxxxQ';
process.env.PAYPAL_SECRET = 'ExxxxQ';
```

---

## 2ï¸âƒ£ æ­¥éª¤2ï¼šprocess.env å¯¹è±¡

### ä»€ä¹ˆæ˜¯ process.envï¼Ÿ

`process.env` æ˜¯ **Node.js çš„å…¨å±€å¯¹è±¡**ï¼ŒåŒ…å«å½“å‰è¿›ç¨‹çš„æ‰€æœ‰ç¯å¢ƒå˜é‡ã€‚

### æŸ¥çœ‹ process.env

```javascript
// åœ¨ä»»ä½• Node.js æ–‡ä»¶ä¸­éƒ½å¯ä»¥è®¿é—®
console.log(process.env.PAYPAL_CLIENT_ID);
// è¾“å‡ºï¼šAxxxxxxxxxxxxQ

console.log(process.env.PAYPAL_MODE);
// è¾“å‡ºï¼šsandbox

console.log(process.env.PORT);
// è¾“å‡ºï¼š3000
```

### process.env çš„ç‰¹ç‚¹

1. **å…¨å±€å¯è®¿é—®**ï¼šä»»ä½• JS æ–‡ä»¶éƒ½èƒ½è¯»å–
2. **å­—ç¬¦ä¸²ç±»å‹**ï¼šæ‰€æœ‰å€¼éƒ½æ˜¯å­—ç¬¦ä¸²
3. **è¿è¡Œæ—¶ç¡®å®š**ï¼šç¨‹åºå¯åŠ¨æ—¶åŠ è½½ï¼Œè¿è¡Œä¸­ä¸å˜

---

## 3ï¸âƒ£ æ­¥éª¤3ï¼šåœ¨ä»£ç ä¸­è¯»å–ç¯å¢ƒå˜é‡

### ç¤ºä¾‹1ï¼šåœ¨ server.js ä¸­

```javascript
// server.js ç¬¬1è¡Œ
require('dotenv').config();  // åŠ è½½ .env æ–‡ä»¶

// ç¬¬15è¡Œ - è¯»å– PORT ç¯å¢ƒå˜é‡
const PORT = process.env.PORT || 3000;
//           ^^^^^^^^^^^^^^^^
//           ä» process.env è¯»å–
//                           ^^^^^
//                           é»˜è®¤å€¼ï¼ˆå¦‚æœæœªè®¾ç½®ï¼‰
```

**è§£é‡Š**ï¼š
- `process.env.PORT`ï¼šå°è¯•è¯»å– PORT ç¯å¢ƒå˜é‡
- `|| 3000`ï¼šå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼ 3000

### ç¤ºä¾‹2ï¼šåœ¨ paypal-service.js ä¸­

```javascript
// services/paypal-service.js ç¬¬6-14è¡Œ
function getPayPalClient() {
    const environment = process.env.PAYPAL_MODE === 'live' 
        //                  ^^^^^^^^^^^^^^^^^^^^^^^^
        //                  è¯»å– PAYPAL_MODE å¹¶åˆ¤æ–­
        ? new paypal.core.LiveEnvironment(
            process.env.PAYPAL_CLIENT_ID,      // è¯»å– Client ID
            //          ^^^^^^^^^^^^^^^^^^^^
            process.env.PAYPAL_CLIENT_SECRET   // è¯»å– Secret
            //          ^^^^^^^^^^^^^^^^^^^^^^^^
          )
        : new paypal.core.SandboxEnvironment(
            process.env.PAYPAL_CLIENT_ID || 'test',  // è¯»å–ï¼Œå¦‚æœä¸ºç©ºç”¨ 'test'
            process.env.PAYPAL_CLIENT_SECRET || 'test'
          );
    
    return new paypal.core.PayPalHttpClient(environment);
}
```

### ç¤ºä¾‹3ï¼šæ£€æŸ¥æ˜¯å¦é…ç½®

```javascript
// services/paypal-service.js ç¬¬36è¡Œ
if (!process.env.PAYPAL_CLIENT_ID || process.env.PAYPAL_CLIENT_ID === 'test') {
    // å¦‚æœæ²¡æœ‰é…ç½® PayPal å‡­è¯
    return {
        isTestMode: true,
        message: 'æµ‹è¯•æ¨¡å¼ï¼šè¯·åœ¨ .env ä¸­é…ç½®çœŸå®çš„ PayPal å¯†é’¥'
    };
}
```

### ç¤ºä¾‹4ï¼šä½¿ç”¨é»˜è®¤å€¼

```javascript
// services/paypal-service.js ç¬¬68-69è¡Œ
return_url: process.env.PAYPAL_RETURN_URL || 'http://localhost:3000/payment-success',
//          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
//          ä¼˜å…ˆä½¿ç”¨ç¯å¢ƒå˜é‡                      å¦‚æœæœªè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼

cancel_url: process.env.PAYPAL_CANCEL_URL || 'http://localhost:3000/payment-cancel'
```

---

## 4ï¸âƒ£ ç¯å¢ƒå˜é‡æ¥æºä¼˜å…ˆçº§

Node.js ä¼šæŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§è¯»å–ç¯å¢ƒå˜é‡ï¼š

```
1. ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼ˆexport è®¾ç½®ï¼‰    â† æœ€é«˜ä¼˜å…ˆçº§
   â†“
2. .env æ–‡ä»¶ä¸­çš„å˜é‡
   â†“
3. ä»£ç ä¸­çš„é»˜è®¤å€¼                 â† æœ€ä½ä¼˜å…ˆçº§
```

### ç¤ºä¾‹

å‡è®¾ï¼š
```bash
# ç³»ç»Ÿç¯å¢ƒå˜é‡
export PAYPAL_MODE=live

# .env æ–‡ä»¶
PAYPAL_MODE=sandbox

# ä»£ç 
const mode = process.env.PAYPAL_MODE || 'development';
```

**ç»“æœ**ï¼š`mode = 'live'`ï¼ˆä½¿ç”¨ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼‰

---

## 5ï¸âƒ£ å®Œæ•´ç¤ºä¾‹ï¼šä»é…ç½®åˆ°ä½¿ç”¨

### .env æ–‡ä»¶å†…å®¹

```bash
# .env
PAYPAL_MODE=sandbox
PAYPAL_CLIENT_ID=AZxxxxxxxxxxxxQ
PAYPAL_CLIENT_SECRET=EJxxxxxxxxxxxxQ
PAYPAL_RETURN_URL=http://localhost:3000/user-center.html#recharge
```

### ç¨‹åºå¯åŠ¨æµç¨‹

```javascript
// 1. server.js ç¬¬1è¡Œ - åŠ è½½ç¯å¢ƒå˜é‡
require('dotenv').config();
// æ­¤æ—¶ process.env.PAYPAL_CLIENT_ID = 'AZxxxxxxxxxxxxQ'
// æ­¤æ—¶ process.env.PAYPAL_MODE = 'sandbox'

// 2. server.js ç¬¬12è¡Œ - å¼•å…¥ PayPal æœåŠ¡
const { createPayPalOrder } = require('./services/paypal-service');

// 3. services/paypal-service.js - PayPal æœåŠ¡è¢«åŠ è½½
// ä½†æ­¤æ—¶è¿˜æ²¡æœ‰è¯»å–ç¯å¢ƒå˜é‡ï¼Œåªæ˜¯å®šä¹‰äº†å‡½æ•°

// 4. ç”¨æˆ·è®¿é—®å……å€¼é¡µé¢ï¼Œç‚¹å‡»"ç¡®è®¤å……å€¼"

// 5. server.js ç¬¬323è¡Œ - è°ƒç”¨åˆ›å»ºè®¢å•
app.post('/api/payment/paypal/create-order', requireAuth, async (req, res) => {
    const result = await createPayPalOrder(req.user.id, amount);
    // â†‘ è°ƒç”¨ PayPal æœåŠ¡
});

// 6. services/paypal-service.js - æ‰§è¡Œåˆ›å»ºè®¢å•å‡½æ•°
async function createPayPalOrder(userId, amount) {
    // æ­¤æ—¶æ‰è¯»å–ç¯å¢ƒå˜é‡
    if (!process.env.PAYPAL_CLIENT_ID || process.env.PAYPAL_CLIENT_ID === 'test') {
        // æ£€æŸ¥æ˜¯å¦é…ç½®
    }
    
    // è°ƒç”¨ getPayPalClient() è·å– PayPal å®¢æˆ·ç«¯
    const client = getPayPalClient();
    // â†‘ è¿™ä¸ªå‡½æ•°ä¼šè¯»å– process.env.PAYPAL_CLIENT_ID ç­‰
}

// 7. getPayPalClient() è¯»å–ç¯å¢ƒå˜é‡
function getPayPalClient() {
    // è¯»å– PAYPAL_MODE
    const environment = process.env.PAYPAL_MODE === 'live' 
        ? new paypal.core.LiveEnvironment(
            process.env.PAYPAL_CLIENT_ID,    // è¯»å– Client ID
            process.env.PAYPAL_CLIENT_SECRET // è¯»å– Secret
          )
        : new paypal.core.SandboxEnvironment(
            process.env.PAYPAL_CLIENT_ID || 'test',
            process.env.PAYPAL_CLIENT_SECRET || 'test'
          );
    
    return new paypal.core.PayPalHttpClient(environment);
}
```

---

## 6ï¸âƒ£ å®æ—¶æµ‹è¯•ç¯å¢ƒå˜é‡

### å‘½ä»¤è¡Œæµ‹è¯•

```bash
# æ–¹æ³•1ï¼šç›´æ¥åœ¨ Node.js ä¸­æµ‹è¯•
node -e "require('dotenv').config(); console.log('CLIENT_ID:', process.env.PAYPAL_CLIENT_ID)"

# æ–¹æ³•2ï¼šåˆ›å»ºæµ‹è¯•è„šæœ¬
cat > test-env.js << 'EOF'
require('dotenv').config();

console.log('ç¯å¢ƒå˜é‡è¯»å–æµ‹è¯•ï¼š');
console.log('==================');
console.log('PAYPAL_MODE:', process.env.PAYPAL_MODE);
console.log('PAYPAL_CLIENT_ID:', process.env.PAYPAL_CLIENT_ID ? 'å·²è®¾ç½® âœ“' : 'æœªè®¾ç½® âœ—');
console.log('PAYPAL_CLIENT_SECRET:', process.env.PAYPAL_CLIENT_SECRET ? 'å·²è®¾ç½® âœ“' : 'æœªè®¾ç½® âœ—');
console.log('PORT:', process.env.PORT);
EOF

node test-env.js
```

### åœ¨ä»£ç ä¸­è°ƒè¯•

```javascript
// åœ¨ä»»ä½•æ–‡ä»¶ä¸­æ·»åŠ 
console.log('å½“å‰ç¯å¢ƒå˜é‡ï¼š', {
    PAYPAL_MODE: process.env.PAYPAL_MODE,
    PAYPAL_CLIENT_ID: process.env.PAYPAL_CLIENT_ID ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®',
    PAYPAL_CLIENT_SECRET: process.env.PAYPAL_CLIENT_SECRET ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®',
});
```

---

## 7ï¸âƒ£ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä¿®æ”¹ .env åä¸ç”Ÿæ•ˆï¼Ÿ

**A**: éœ€è¦**é‡å¯æœåŠ¡å™¨**ï¼Œå› ä¸º `.env` åªåœ¨ç¨‹åºå¯åŠ¨æ—¶åŠ è½½ä¸€æ¬¡ã€‚

```bash
# åœæ­¢æœåŠ¡å™¨
pkill -f "node server.js"

# é‡æ–°å¯åŠ¨
npm start
```

### Q2: å¦‚ä½•åˆ¤æ–­ç¯å¢ƒå˜é‡æ˜¯å¦åŠ è½½æˆåŠŸï¼Ÿ

**A**: åœ¨ä»£ç ä¸­æ·»åŠ æ—¥å¿—ï¼š

```javascript
// server.js ç¬¬2è¡Œåæ·»åŠ 
console.log('PayPalé…ç½®çŠ¶æ€ï¼š', {
    CLIENT_ID: process.env.PAYPAL_CLIENT_ID ? 'å·²åŠ è½½ âœ“' : 'æœªåŠ è½½ âœ—',
    MODE: process.env.PAYPAL_MODE
});
```

### Q3: .env æ–‡ä»¶ä¸­çš„å€¼éœ€è¦åŠ å¼•å·å—ï¼Ÿ

**A**: **ä¸éœ€è¦**ï¼ˆé™¤éå€¼æœ¬èº«åŒ…å«ç©ºæ ¼ï¼‰

```bash
# âœ“ æ­£ç¡®
PAYPAL_CLIENT_ID=AxxxxxxxxxxxxQ

# âœ— é”™è¯¯ï¼ˆä¼šæŠŠå¼•å·ä¹Ÿè¯»å–è¿›å»ï¼‰
PAYPAL_CLIENT_ID="AxxxxxxxxxxxxQ"

# âœ“ åªæœ‰åŒ…å«ç©ºæ ¼æ—¶æ‰éœ€è¦
MY_MESSAGE="Hello World"
```

### Q4: å¦‚ä½•åœ¨ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒé…ç½®ï¼Ÿ

**A**: ä½¿ç”¨ä¸åŒçš„ .env æ–‡ä»¶ï¼š

```bash
# å¼€å‘ç¯å¢ƒ
.env.development

# ç”Ÿäº§ç¯å¢ƒ
.env.production

# åŠ è½½ç‰¹å®šæ–‡ä»¶
require('dotenv').config({ path: '.env.production' });
```

---

## 8ï¸âƒ£ å®‰å…¨å»ºè®®

### âœ… åº”è¯¥åšçš„

1. **ä¸è¦æäº¤ .env åˆ° Git**
   ```bash
   # .gitignore ä¸­å·²åŒ…å«
   .env
   ```

2. **ä½¿ç”¨ .env.example ä½œä¸ºæ¨¡æ¿**
   ```bash
   # .env.exampleï¼ˆå¯ä»¥æäº¤ï¼‰
   PAYPAL_CLIENT_ID=your_client_id_here
   
   # .envï¼ˆä¸æäº¤ï¼ŒåŒ…å«çœŸå®å‡­è¯ï¼‰
   PAYPAL_CLIENT_ID=AxxxxxxxxxxxxQ
   ```

3. **ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç³»ç»Ÿç¯å¢ƒå˜é‡**
   ```bash
   # åœ¨æœåŠ¡å™¨ä¸Šè®¾ç½®
   export PAYPAL_CLIENT_ID="çœŸå®å‡­è¯"
   export PAYPAL_MODE="live"
   ```

### âŒ ä¸åº”è¯¥åšçš„

1. **ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å‡­è¯**
   ```javascript
   // âœ— é”™è¯¯
   const clientId = "AxxxxxxxxxxxxQ";
   
   // âœ“ æ­£ç¡®
   const clientId = process.env.PAYPAL_CLIENT_ID;
   ```

2. **ä¸è¦å°† .env æäº¤åˆ° Git**
3. **ä¸è¦åœ¨æ—¥å¿—ä¸­æ‰“å°æ•æ„Ÿä¿¡æ¯**

---

## ğŸ“‹ æ€»ç»“

### ç¯å¢ƒå˜é‡è¯»å–æµç¨‹

```
1. ç¨‹åºå¯åŠ¨
   â†“
2. require('dotenv').config() æ‰§è¡Œ
   â†“
3. è¯»å– .env æ–‡ä»¶
   â†“
4. è§£æå¹¶æ³¨å…¥åˆ° process.env
   â†“
5. ä»£ç ä¸­é€šè¿‡ process.env.XXX è¯»å–
   â†“
6. ä½¿ç”¨é…ç½®å€¼
```

### å…³é”®ä»£ç ä½ç½®

| ä½ç½® | ä½œç”¨ | ä»£ç  |
|-----|------|-----|
| `server.js:1` | åŠ è½½ç¯å¢ƒå˜é‡ | `require('dotenv').config()` |
| `server.js:15` | è¯»å– PORT | `process.env.PORT` |
| `paypal-service.js:6-14` | è¯»å– PayPal é…ç½® | `process.env.PAYPAL_*` |
| `paypal-service.js:36` | æ£€æŸ¥æ˜¯å¦é…ç½® | `!process.env.PAYPAL_CLIENT_ID` |

### å¿«é€Ÿæ£€æŸ¥å‘½ä»¤

```bash
# æŸ¥çœ‹ .env æ–‡ä»¶
cat .env | grep PAYPAL

# æµ‹è¯•ç¯å¢ƒå˜é‡åŠ è½½
node -e "require('dotenv').config(); console.log(process.env.PAYPAL_CLIENT_ID)"

# é‡å¯æœåŠ¡å™¨
pkill -f "node server.js" && npm start
```

---

**ç°åœ¨æ‚¨åº”è¯¥å®Œå…¨ç†è§£ç¯å¢ƒå˜é‡çš„è¯»å–æœºåˆ¶äº†ï¼** ğŸ‰


