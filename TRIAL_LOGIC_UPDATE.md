# ğŸ¯ è¯•ç”¨é€»è¾‘æ›´æ–°è¯´æ˜

## ğŸ“‹ æ›´æ–°æ¦‚è§ˆ

æ ¹æ®æ–°éœ€æ±‚ï¼Œå·²å®Œæˆä»¥ä¸‹ä¿®æ”¹ï¼š

### 1ï¸âƒ£ æœªç™»å½•ç”¨æˆ·è¯•ç”¨é™åˆ¶
- **æ¯æ¬¡åªèƒ½ç”Ÿæˆ**: 2å¼ å¡ç‰‡
- **æ€»å…±å¯è¯•ç”¨**: 3æ¬¡ï¼ˆå…±6å¼ å¡ç‰‡ï¼‰
- **é˜²åˆ·æ–°æœºåˆ¶**: ä½¿ç”¨ localStorage è¿½è¸ªï¼Œåˆ·æ–°æµè§ˆå™¨ä¸ä¼šé‡ç½®

### 2ï¸âƒ£ æ³¨å†Œç”¨æˆ·ä¼˜æƒ 
- **æ³¨å†Œå³é€**: 300ç§¯åˆ†
- **å¯ç”Ÿæˆå¡ç‰‡**: 20å¼ ï¼ˆ15ç§¯åˆ†/å¼  Ã— 20 = 300ç§¯åˆ†ï¼‰
- **æ— è¯•ç”¨é¢åº¦**: ç›´æ¥ä½¿ç”¨ç§¯åˆ†ç³»ç»Ÿ

## ğŸ”„ ä¿®æ”¹è¯¦æƒ…

### æ•°æ®åº“é…ç½®æ›´æ–°

#### æ–°å¢é…ç½®é¡¹
```sql
-- ç³»ç»Ÿé…ç½®è¡¨æ–°å¢
free_trial_times = 3              -- æœªç™»å½•ç”¨æˆ·è¯•ç”¨æ¬¡æ•°
free_trial_cards_per_time = 2     -- æ¯æ¬¡å¯ç”Ÿæˆå¡ç‰‡æ•°
new_user_gift_credits = 300       -- æ–°ç”¨æˆ·æ³¨å†Œèµ é€ç§¯åˆ†
```

#### åˆ é™¤é…ç½®é¡¹
```sql
-- å·²åˆ é™¤ï¼ˆä¸å†ä½¿ç”¨ï¼‰
free_trial_cards = 10             -- åŸï¼šæœªç™»å½•è¯•ç”¨å¡ç‰‡æ•°
logged_in_trial_cards = 10        -- åŸï¼šç™»å½•é¢å¤–è¯•ç”¨æ•°
```

### åç«¯é€»è¾‘ä¿®æ”¹

#### 1. ç”¨æˆ·æ³¨å†Œï¼ˆ`server.js`ï¼‰

**ä¿®æ”¹ä½ç½®**: `/api/auth/register`

```javascript
// æ–°å¢ï¼šæ³¨å†Œæ—¶èµ é€ç§¯åˆ†
const giftCredits = parseInt(await configOperations.get('new_user_gift_credits') || '300');
await userOperations.updateCredits(userId, giftCredits, 'recharge', 'æ–°ç”¨æˆ·æ³¨å†Œèµ é€');
```

**ç»“æœ**: 
- âœ… æ–°ç”¨æˆ·æ³¨å†Œåè‡ªåŠ¨è·å¾—300ç§¯åˆ†
- âœ… åœ¨ `credit_transactions` è¡¨ä¸­è®°å½•äº¤æ˜“

#### 2. å¡ç‰‡ç”Ÿæˆæƒé™æ£€æŸ¥ï¼ˆ`server.js`ï¼‰

**æœªç™»å½•ç”¨æˆ·é€»è¾‘**:
```javascript
// 1. é™åˆ¶æ¯æ¬¡ç”Ÿæˆæ•°é‡
if (requestedCards > 2) {
    return error: 'æœªç™»å½•ç”¨æˆ·æ¯æ¬¡åªèƒ½ç”Ÿæˆ2å¼ å¡ç‰‡'
}

// 2. æ£€æŸ¥è¯•ç”¨æ¬¡æ•°ï¼ˆä¸æ˜¯å¡ç‰‡æ•°ï¼‰
SELECT COUNT(*) FROM card_generations 
WHERE session_id = ? AND is_trial = 1

// 3. è¶…è¿‡3æ¬¡åˆ™æç¤ºç™»å½•
if (trialCount >= 3) {
    return error: 'å…è´¹è¯•ç”¨æ¬¡æ•°å·²ç”¨å®Œï¼Œè¯·ç™»å½•ç»§ç»­ä½¿ç”¨'
}
```

**å·²ç™»å½•ç”¨æˆ·é€»è¾‘**:
```javascript
// ä¸å†æœ‰è¯•ç”¨é¢åº¦ï¼Œç›´æ¥ä½¿ç”¨ç§¯åˆ†
const requiredCredits = cardCount * 15;
if (user.credits < requiredCredits) {
    return error: 'ç§¯åˆ†ä¸è¶³ï¼Œè¯·å……å€¼'
}
```

### å‰ç«¯æ˜¾ç¤ºæ›´æ–°

#### 1. å¯¼èˆªæ æ˜¾ç¤ºï¼ˆ`app.js` + `index.html`ï¼‰

**æœªç™»å½•çŠ¶æ€**:
```
ğŸ å…è´¹è¯•ç”¨: 3/3 æ¬¡  (å‰©ä½™æ¬¡æ•°/æ€»æ¬¡æ•°)
```

**å·²ç™»å½•çŠ¶æ€**:
```
ğŸ’ ç§¯åˆ†: 300  (ä¸å†æ˜¾ç¤ºè¯•ç”¨)
```

#### 2. localStorage è¿½è¸ª

**å­˜å‚¨é”®å**: `anonymousTrialUsed`

**æ›´æ–°æ—¶æœº**: æ¯æ¬¡æˆåŠŸç”Ÿæˆå¡ç‰‡å
```javascript
const usedTimes = parseInt(localStorage.getItem('anonymousTrialUsed') || '0');
localStorage.setItem('anonymousTrialUsed', (usedTimes + 1).toString());
```

**è¯»å–æ˜¾ç¤º**:
```javascript
const usedTimes = parseInt(localStorage.getItem('anonymousTrialUsed') || '0');
const remaining = Math.max(0, 3 - usedTimes);
display: `${remaining}/3 æ¬¡`
```

#### 3. ç™»å½•é¡µé¢æç¤ºï¼ˆ`auth.html`ï¼‰

```
ğŸ æœªç™»å½•ç”¨æˆ·ï¼šæ¯æ¬¡ç”Ÿæˆ2å¼ ï¼Œå…±å¯è¯•ç”¨3æ¬¡
ğŸ‰ æ³¨å†Œå³é€300ç§¯åˆ†ï¼ˆå¯ç”Ÿæˆ20å¼ å¡ç‰‡ï¼‰
```

#### 4. ç”¨æˆ·ä¸­å¿ƒè¯´æ˜ï¼ˆ`user-center.html`ï¼‰

```
â€¢ ç”Ÿæˆæ¯å¼ å¡ç‰‡æ¶ˆè€— 15 ç§¯åˆ†
â€¢ å……å€¼æ±‡ç‡ï¼š1å…ƒ = 100ç§¯åˆ†
â€¢ æœªç™»å½•ç”¨æˆ·ï¼šæ¯æ¬¡ç”Ÿæˆ2å¼ ï¼Œå…±å¯è¯•ç”¨ 3 æ¬¡
â€¢ æ–°ç”¨æˆ·æ³¨å†Œï¼šèµ é€ 300 ç§¯åˆ†ï¼ˆå¯ç”Ÿæˆ20å¼ å¡ç‰‡ï¼‰
```

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯1: æœªç™»å½•ç”¨æˆ·è¯•ç”¨

**æ­¥éª¤**:
1. æ¸…é™¤ localStorage: `localStorage.clear()`
2. è®¿é—®ä¸»é¡µï¼Œæ˜¾ç¤º "ğŸ å…è´¹è¯•ç”¨: 3/3 æ¬¡"
3. è¾“å…¥ææ–™ï¼Œè®¾ç½®ç”Ÿæˆ 2 å¼ å¡ç‰‡
4. ç‚¹å‡»"åˆ¶å¡"
5. æˆåŠŸç”Ÿæˆï¼Œæ˜¾ç¤ºæ›´æ–°ä¸º "2/3 æ¬¡"
6. é‡å¤2æ¬¡ï¼Œæ€»å…±3æ¬¡
7. ç¬¬4æ¬¡å°è¯•æ—¶æç¤º "å…è´¹è¯•ç”¨æ¬¡æ•°å·²ç”¨å®Œ"

**åˆ·æ–°æµ‹è¯•**:
- åˆ·æ–°æµè§ˆå™¨åï¼Œè¯•ç”¨æ¬¡æ•°ä¿æŒä¸å˜ï¼ˆlocalStorage ä¿å­˜ï¼‰
- åªæœ‰æ¸…é™¤æµè§ˆå™¨æ•°æ®æ‰ä¼šé‡ç½®

**å°è¯•ç”Ÿæˆè¶…è¿‡2å¼ **:
```
è¾“å…¥ï¼š3å¼ å¡ç‰‡
ç»“æœï¼šâŒ "æœªç™»å½•ç”¨æˆ·æ¯æ¬¡åªèƒ½ç”Ÿæˆ2å¼ å¡ç‰‡ï¼Œè¯·ç™»å½•åç”Ÿæˆæ›´å¤š"
```

### åœºæ™¯2: æ–°ç”¨æˆ·æ³¨å†Œ

**æ­¥éª¤**:
1. ç‚¹å‡»"ç™»å½•/æ³¨å†Œ"
2. å¡«å†™æ³¨å†Œä¿¡æ¯
3. æäº¤æ³¨å†Œ
4. âœ… è‡ªåŠ¨ç™»å½•ï¼Œæ˜¾ç¤º "ğŸ’ ç§¯åˆ†: 300"
5. å¯ä»¥ç”Ÿæˆå¡ç‰‡ï¼Œæ¯å¼ æ‰£é™¤ 15 ç§¯åˆ†

**éªŒè¯ç§¯åˆ†**:
- ç”Ÿæˆ 1 å¼ : 300 - 15 = 285 ç§¯åˆ†
- ç”Ÿæˆ 10 å¼ : 300 - 150 = 150 ç§¯åˆ†
- ç”Ÿæˆ 20 å¼ : 300 - 300 = 0 ç§¯åˆ†

### åœºæ™¯3: å·²æœ‰ç”¨æˆ·ç™»å½•

**æ­¥éª¤**:
1. ä½¿ç”¨å·²æ³¨å†Œè´¦å·ç™»å½•
2. æ˜¾ç¤ºå®é™…ç§¯åˆ†ä½™é¢
3. ä¸å†æœ‰è¯•ç”¨é¢åº¦ï¼Œå…¨éƒ¨ä½¿ç”¨ç§¯åˆ†

## ğŸ“Š æ•°æ®åº“æŸ¥è¯¢

### æŸ¥çœ‹æ–°ç”¨æˆ·æ³¨å†Œèµ é€è®°å½•

```sql
-- æŸ¥çœ‹æ³¨å†Œèµ é€è®°å½•
SELECT 
    u.username,
    ct.amount,
    ct.description,
    ct.created_at
FROM credit_transactions ct
JOIN users u ON ct.user_id = u.id
WHERE ct.description = 'æ–°ç”¨æˆ·æ³¨å†Œèµ é€'
ORDER BY ct.created_at DESC;
```

### æŸ¥çœ‹åŒ¿åç”¨æˆ·è¯•ç”¨ç»Ÿè®¡

```sql
-- ç»Ÿè®¡åŒ¿åç”¨æˆ·è¯•ç”¨æ¬¡æ•°
SELECT 
    session_id,
    COUNT(*) as trial_times,
    SUM(card_count) as total_cards
FROM card_generations
WHERE user_id IS NULL AND is_trial = 1
GROUP BY session_id
ORDER BY trial_times DESC;
```

### æ›´æ–°ç³»ç»Ÿé…ç½®

```sql
-- ä¿®æ”¹é…ç½®å€¼
UPDATE system_config SET value = '5' WHERE key = 'free_trial_times';
UPDATE system_config SET value = '3' WHERE key = 'free_trial_cards_per_time';
UPDATE system_config SET value = '500' WHERE key = 'new_user_gift_credits';
```

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•æ¸…é™¤ç”¨æˆ·çš„è¯•ç”¨è®°å½•ï¼Ÿ

**æ¸…é™¤ localStorageï¼ˆå‰ç«¯ï¼‰**:
```javascript
localStorage.removeItem('anonymousTrialUsed');
// æˆ–æ¸…é™¤æ‰€æœ‰
localStorage.clear();
```

**æ¸…é™¤æ•°æ®åº“è®°å½•ï¼ˆåç«¯ï¼‰**:
```sql
-- æ¸…é™¤ç‰¹å®š session çš„è¯•ç”¨è®°å½•
DELETE FROM card_generations 
WHERE session_id = 'anon_xxx' AND is_trial = 1;

-- æ¸…é™¤æ‰€æœ‰åŒ¿åè¯•ç”¨è®°å½•
DELETE FROM card_generations 
WHERE user_id IS NULL AND is_trial = 1;
```

### Q2: å¦‚ä½•ä¿®æ”¹èµ é€ç§¯åˆ†æ•°é‡ï¼Ÿ

```sql
-- æ–¹æ³•1: ä¿®æ”¹ç³»ç»Ÿé…ç½®ï¼ˆå½±å“æ–°æ³¨å†Œç”¨æˆ·ï¼‰
UPDATE system_config 
SET value = '500' 
WHERE key = 'new_user_gift_credits';

-- æ–¹æ³•2: æ‰‹åŠ¨ç»™ç°æœ‰ç”¨æˆ·å……å€¼
-- å‚è€ƒ DATABASE_MAINTENANCE.md
```

### Q3: å¦‚ä½•ä¿®æ”¹æ¯æ¬¡è¯•ç”¨å¡ç‰‡æ•°ï¼Ÿ

```sql
-- ä¿®æ”¹æ¯æ¬¡å¯ç”Ÿæˆå¡ç‰‡æ•°ï¼ˆ1-20å¼ ï¼‰
UPDATE system_config 
SET value = '5' 
WHERE key = 'free_trial_cards_per_time';

-- ä¿®æ”¹æ€»è¯•ç”¨æ¬¡æ•°
UPDATE system_config 
SET value = '5' 
WHERE key = 'free_trial_times';
```

### Q4: ä¸ºä»€ä¹ˆåˆ·æ–°åè¯•ç”¨æ¬¡æ•°æ²¡å˜ï¼Ÿ

è¿™æ˜¯**é¢„æœŸè¡Œä¸º**ï¼Œä½¿ç”¨ localStorage é˜²æ­¢åˆ·æ–°é‡ç½®ï¼š
- âœ… åˆ·æ–°é¡µé¢ï¼šè¯•ç”¨æ¬¡æ•°ä¿æŒ
- âœ… å…³é—­æµè§ˆå™¨é‡æ–°æ‰“å¼€ï¼šè¯•ç”¨æ¬¡æ•°ä¿æŒ
- âœ… æ¸…é™¤æµè§ˆå™¨æ•°æ®ï¼šè¯•ç”¨æ¬¡æ•°é‡ç½®
- âœ… ä½¿ç”¨æ— ç—•æ¨¡å¼ï¼šæ¯æ¬¡éƒ½æ˜¯æ–°çš„

### Q5: å·²ç™»å½•ç”¨æˆ·è¿˜æœ‰è¯•ç”¨é¢åº¦å—ï¼Ÿ

**âŒ æ²¡æœ‰**ã€‚ä¿®æ”¹åçš„é€»è¾‘ï¼š
- æœªç™»å½•ç”¨æˆ·ï¼š3æ¬¡è¯•ç”¨æœºä¼š
- å·²ç™»å½•ç”¨æˆ·ï¼šç›´æ¥ä½¿ç”¨ç§¯åˆ†ï¼ˆæ³¨å†Œé€300ï¼‰

## ğŸ¯ åŠŸèƒ½å¯¹æ¯”

### ä¿®æ”¹å‰

| ç”¨æˆ·ç±»å‹ | è¯•ç”¨é¢åº¦ | é™åˆ¶ |
|---------|---------|------|
| æœªç™»å½• | 10å¼ å¡ç‰‡ | å¯åˆ·æ–°é‡ç½® |
| å·²ç™»å½• | 20å¼ å¡ç‰‡ | ç”¨å®Œåä½¿ç”¨ç§¯åˆ† |

### ä¿®æ”¹å âœ¨

| ç”¨æˆ·ç±»å‹ | è¯•ç”¨é¢åº¦ | é™åˆ¶ | é˜²åˆ·æ–° |
|---------|---------|------|--------|
| æœªç™»å½• | 3æ¬¡ï¼ˆæ¯æ¬¡2å¼ ï¼‰ | å…±6å¼ å¡ç‰‡ | âœ… localStorage |
| å·²ç™»å½• | âŒ æ— è¯•ç”¨ | ä½¿ç”¨ç§¯åˆ†ï¼ˆæ³¨å†Œé€300ï¼‰ | - |

## ğŸ“ é…ç½®æ–‡ä»¶

### .env é…ç½®æ— éœ€ä¿®æ”¹
æ‰€æœ‰é…ç½®å­˜å‚¨åœ¨æ•°æ®åº“ `system_config` è¡¨ä¸­ï¼Œå¯ä»¥åŠ¨æ€ä¿®æ”¹ï¼Œæ— éœ€é‡å¯æœåŠ¡å™¨ã€‚

### ç›¸å…³æ–‡ä»¶æ¸…å•

**åç«¯**:
- âœ… `database/db.js` - æ•°æ®åº“é…ç½®åˆå§‹åŒ–
- âœ… `server.js` - æ³¨å†Œèµ é€ã€æƒé™æ£€æŸ¥é€»è¾‘

**å‰ç«¯**:
- âœ… `public/app.js` - localStorage è¿½è¸ªã€æ˜¾ç¤ºé€»è¾‘
- âœ… `public/index.html` - å¯¼èˆªæ æ˜¾ç¤º
- âœ… `public/auth.html` - ç™»å½•é¡µæç¤º
- âœ… `public/user-center.html` - ç”¨æˆ·ä¸­å¿ƒè¯´æ˜

## âœ… éªŒè¯æ¸…å•

- [x] æœªç™»å½•ç”¨æˆ·æ¯æ¬¡åªèƒ½ç”Ÿæˆ2å¼ 
- [x] æœªç™»å½•ç”¨æˆ·æ€»å…±åªèƒ½è¯•ç”¨3æ¬¡
- [x] ä½¿ç”¨ localStorage é˜²æ­¢åˆ·æ–°é‡ç½®
- [x] æ–°ç”¨æˆ·æ³¨å†Œè‡ªåŠ¨èµ é€300ç§¯åˆ†
- [x] å·²ç™»å½•ç”¨æˆ·ä¸å†æœ‰è¯•ç”¨é¢åº¦
- [x] å‰ç«¯æ˜¾ç¤ºæ­£ç¡®æ›´æ–°
- [x] ç™»å½•é¡µæç¤ºæ­£ç¡®
- [x] ç”¨æˆ·ä¸­å¿ƒè¯´æ˜æ­£ç¡®
- [x] æ•°æ®åº“é…ç½®æ­£ç¡®åˆå§‹åŒ–

## ğŸš€ ç«‹å³æµ‹è¯•

1. **æ¸…é™¤ localStorage**:
   ```javascript
   // åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
   localStorage.clear();
   location.reload();
   ```

2. **è®¿é—®ä¸»é¡µ**: http://localhost:3000
   - åº”æ˜¾ç¤º "ğŸ å…è´¹è¯•ç”¨: 3/3 æ¬¡"

3. **æµ‹è¯•è¯•ç”¨**:
   - ç”Ÿæˆ2å¼ å¡ç‰‡ âœ…
   - é‡å¤3æ¬¡
   - ç¬¬4æ¬¡æç¤ºç™»å½• âœ…

4. **æµ‹è¯•æ³¨å†Œ**:
   - æ³¨å†Œæ–°è´¦å·
   - è‡ªåŠ¨è·å¾—300ç§¯åˆ† âœ…
   - å¯ç”Ÿæˆ20å¼ å¡ç‰‡

---

**æ›´æ–°æ—¶é—´**: 2025-10-15  
**ç‰ˆæœ¬**: v2.1  
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶æµ‹è¯•


