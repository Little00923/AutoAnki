# 🎉 AutoAnki 云服务器部署方案完成总结

## 📦 已创建的文件

### 1. 核心部署脚本

| 文件 | 大小 | 功能 | 使用方式 |
|------|------|------|----------|
| **deploy.sh** | 10KB | 一键部署脚本，支持Docker/PM2/Nginx | `sudo ./deploy.sh` |
| **update.sh** | 4.4KB | 智能更新脚本，自动检测部署方式 | `./update.sh` |
| **backup.sh** | 1.7KB | 数据库备份脚本，自动清理旧备份 | `./backup.sh` |
| **restart.sh** | 28行 | 快速重启脚本 | `./restart.sh` |

✅ **所有脚本已添加执行权限**

### 2. 配置文件

| 文件 | 大小 | 功能 |
|------|------|------|
| **ecosystem.config.js** | 797B | PM2进程管理配置 |
| **nginx.conf.template** | 4.6KB | Nginx反向代理配置模板 |
| **docker-compose.yml** | 已优化 | Docker编排配置（已添加健康检查和环境变量） |

### 3. 文档

| 文件 | 大小 | 内容 | 适用场景 |
|------|------|------|----------|
| **DEPLOYMENT_GUIDE.md** | 14KB | 完整部署指南 | 详细了解部署流程 |
| **QUICK_DEPLOY.md** | 5.5KB | 快速部署指南 | 5分钟快速上手 |
| **DEPLOYMENT_CHECKLIST.md** | 8.1KB | 部署检查清单 | 确保不遗漏步骤 |
| **README.md** | 已更新 | 添加了云服务器部署章节 | 项目主文档 |

---

## 🚀 支持的部署方式

### 方案一：Docker部署（推荐）⭐

**优势：**
- ✅ 环境完全隔离，不污染系统
- ✅ 一键启动，配置简单
- ✅ 容易迁移和扩展
- ✅ 支持健康检查和自动重启

**使用：**
```bash
sudo ./deploy.sh
# 选择：1 (Docker部署)
```

### 方案二：PM2部署

**优势：**
- ✅ 传统Node.js部署方式
- ✅ 灵活的进程管理
- ✅ 实时监控和日志
- ✅ 支持集群模式

**使用：**
```bash
sudo ./deploy.sh
# 选择：2 (PM2部署)
```

### 方案三：Nginx反向代理

**优势：**
- ✅ 支持域名访问
- ✅ 支持HTTPS/SSL
- ✅ 静态文件缓存加速
- ✅ 负载均衡支持

**使用：**
```bash
sudo ./deploy.sh
# 选择：3 (仅安装Nginx)
# 或选择：4 (完整部署)
```

---

## 📋 快速开始

### 最简单的方式（Docker）

```bash
# 1. SSH登录服务器
ssh root@你的服务器IP

# 2. 克隆项目
git clone https://github.com/yourusername/newAutoAnki.git
cd newAutoAnki

# 3. 配置环境变量
cp .env.example .env
nano .env
# 修改：OPENAI_API_KEY, JWT_SECRET, SESSION_SECRET

# 4. 一键部署
chmod +x deploy.sh
sudo ./deploy.sh
# 选择：1

# 5. 完成！访问 http://你的服务器IP:3000
```

**部署时间：约5-10分钟**

---

## 🔧 配置要求

### 服务器最低要求

| 项目 | 要求 |
|------|------|
| 内存 | 1GB（推荐2GB+） |
| 磁盘 | 10GB+ |
| 操作系统 | Ubuntu 20.04+ / CentOS 7+ |
| 网络 | 需要公网IP，开放80/443/3000端口 |

### 必需配置项

在 `.env` 文件中必须配置：

```env
# 1. AI API（必填）
OPENAI_API_KEY=sk-your-actual-key

# 2. 安全密钥（必须修改）
JWT_SECRET=随机字符串32字符以上
SESSION_SECRET=另一个随机字符串

# 3. PayPal（如需支付功能）
PAYPAL_MODE=live
PAYPAL_CLIENT_ID=你的Client ID
PAYPAL_CLIENT_SECRET=你的Secret
```

**生成安全密钥：**
```bash
openssl rand -base64 32
```

---

## 📊 部署方案对比

| 特性 | Docker | PM2 | 手动 |
|------|--------|-----|------|
| 安装难度 | ⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| 环境隔离 | ✅ 完全隔离 | ❌ 共享环境 | ❌ 共享环境 |
| 资源占用 | 中等 | 较低 | 最低 |
| 扩展性 | ✅ 优秀 | ✅ 良好 | ❌ 一般 |
| 监控管理 | ✅ | ✅ | ❌ |
| 推荐指数 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐ |

---

## 🛠️ 维护操作

### 日常维护

```bash
# 查看服务状态
docker-compose ps              # Docker方式
pm2 status                     # PM2方式

# 查看日志
docker-compose logs -f         # Docker方式
pm2 logs autoanki             # PM2方式

# 重启服务
docker-compose restart         # Docker方式
pm2 restart autoanki          # PM2方式

# 备份数据库
./backup.sh

# 更新应用
./update.sh
```

### 定时任务

```bash
# 编辑定时任务
crontab -e

# 添加以下内容：
# 每天凌晨2点备份数据库
0 2 * * * cd /path/to/newAutoAnki && ./backup.sh

# 每周日凌晨3点自动更新（可选）
0 3 * * 0 cd /path/to/newAutoAnki && ./update.sh
```

---

## 🌐 配置域名和HTTPS

### 1. DNS配置

在域名服务商处添加A记录：
```
主机记录: @       记录值: 服务器IP
主机记录: www     记录值: 服务器IP
```

### 2. Nginx配置

```bash
# 使用模板
sudo cp nginx.conf.template /etc/nginx/sites-available/autoanki

# 修改域名
sudo nano /etc/nginx/sites-available/autoanki
# 将 yourdomain.com 替换为实际域名

# 启用配置
sudo ln -s /etc/nginx/sites-available/autoanki /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### 3. SSL证书（Let's Encrypt免费）

```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx -y

# 一键配置SSL
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com

# 完成！现在可以通过 https://yourdomain.com 访问
```

---

## 🔒 安全建议

1. ✅ **修改默认密钥**
   - `JWT_SECRET` 和 `SESSION_SECRET` 必须改为随机字符串

2. ✅ **配置防火墙**
   ```bash
   sudo ufw allow 22/80/443
   sudo ufw enable
   ```

3. ✅ **使用HTTPS**
   - 配置SSL证书，保护数据传输

4. ✅ **定期备份**
   - 设置自动备份任务

5. ✅ **定期更新**
   - 保持系统和依赖最新

---

## 📚 文档导航

| 文档 | 适用场景 | 阅读时间 |
|------|----------|----------|
| [QUICK_DEPLOY.md](QUICK_DEPLOY.md) | 快速上手 | 5分钟 |
| [DEPLOYMENT_GUIDE.md](DEPLOYMENT_GUIDE.md) | 详细学习 | 20分钟 |
| [DEPLOYMENT_CHECKLIST.md](DEPLOYMENT_CHECKLIST.md) | 部署检查 | 10分钟 |
| [README.md](README.md) | 项目概览 | 5分钟 |

---

## 🎯 部署流程图

```
┌─────────────────┐
│  准备云服务器     │
│  配置DNS(可选)   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  克隆项目代码     │
│  配置.env文件    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     选择部署方式
│ 运行deploy.sh   ├─────┬─────┬─────┐
└─────────────────┘     │     │     │
                        ▼     ▼     ▼
                    Docker  PM2  Nginx
                        │     │     │
                        └──┬──┴─────┘
                           ▼
                   ┌─────────────────┐
                   │  配置Nginx(可选) │
                   │  配置SSL(推荐)   │
                   └────────┬────────┘
                            ▼
                   ┌─────────────────┐
                   │   部署完成！     │
                   │   开始使用       │
                   └─────────────────┘
```

---

## ✨ 特色功能

### 1. 智能部署检测

`deploy.sh` 脚本会：
- ✅ 自动检测系统类型
- ✅ 自动安装缺失的依赖
- ✅ 提供友好的交互式界面
- ✅ 完整的错误提示和日志

### 2. 智能更新

`update.sh` 脚本会：
- ✅ 自动检测部署方式
- ✅ 自动备份数据库
- ✅ 智能更新依赖
- ✅ 验证服务状态

### 3. 健康检查

- Docker配置包含健康检查
- 自动检测服务可用性
- 异常时自动重启

---

## 🆘 故障排除

### 服务无法启动

```bash
# 查看日志
docker-compose logs -f    # Docker
pm2 logs autoanki        # PM2

# 检查端口
sudo lsof -i :3000

# 检查磁盘空间
df -h
```

### API调用失败

1. 检查 `.env` 中的 `OPENAI_API_KEY`
2. 验证API余额是否充足
3. 检查网络连接

### 数据库问题

```bash
# 备份当前数据库
./backup.sh

# 从备份恢复（如需要）
cp backups/autoanki_xxx.db database/autoanki.db
```

---

## 📈 性能优化建议

1. **使用Nginx反向代理** - 提升静态文件访问速度
2. **启用Gzip压缩** - 减少传输数据量
3. **配置CDN** - 加速全球访问（可选）
4. **增加服务器资源** - 2GB内存以上为佳
5. **定期清理日志** - 避免占用过多磁盘空间

---

## 🎊 完成确认

部署完成后，请确认：

- [ ] 可以通过浏览器访问应用
- [ ] 健康检查API返回正常：`curl http://localhost:3000/api/health`
- [ ] 用户可以注册和登录
- [ ] 可以生成卡片
- [ ] 可以导出卡包
- [ ] （可选）PayPal支付正常
- [ ] （推荐）已配置HTTPS
- [ ] （推荐）已设置自动备份

---

## 📞 获取帮助

如遇到问题：

1. 查看对应的文档（DEPLOYMENT_GUIDE.md等）
2. 检查日志文件
3. 在GitHub提交Issue
4. 查看项目其他文档

---

## 🎉 总结

你现在拥有：

- ✅ **3种部署方式**（Docker/PM2/Nginx）
- ✅ **一键部署脚本** - 自动化安装和配置
- ✅ **智能更新脚本** - 轻松更新代码
- ✅ **自动备份脚本** - 保护数据安全
- ✅ **完整的文档** - 14KB详细指南
- ✅ **健康检查** - 自动监控服务状态
- ✅ **SSL支持** - 安全的HTTPS访问

**一切准备就绪，开始部署吧！** 🚀

---

*文档生成时间：2025-10-17*
*AutoAnki版本：1.0.0*


