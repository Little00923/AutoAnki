# ğŸ’° æ”¯ä»˜é…ç½®æŒ‡å—

## æ¦‚è¿°

AutoAnki æ”¯æŒå¾®ä¿¡æ”¯ä»˜å’Œæ”¯ä»˜å®ä¸¤ç§æ”¯ä»˜æ–¹å¼ã€‚ç›®å‰ä»£ç ä¸­å®ç°äº†æ”¯ä»˜æ¥å£æ¡†æ¶ï¼Œæ‚¨éœ€è¦å®Œæˆä»¥ä¸‹é…ç½®æ‰èƒ½å¯ç”¨çœŸå®æ”¯ä»˜åŠŸèƒ½ã€‚

---

## ğŸ”§ é…ç½®æ­¥éª¤

### æ–¹æ³•1ï¼šç¯å¢ƒå˜é‡é…ç½®ï¼ˆæ¨èï¼‰

åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ `.env` æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```bash
# å¾®ä¿¡æ”¯ä»˜é…ç½®
WECHAT_APP_ID=ä½ çš„å¾®ä¿¡AppID
WECHAT_MCH_ID=ä½ çš„å•†æˆ·å·
WECHAT_API_KEY=ä½ çš„APIå¯†é’¥
WECHAT_NOTIFY_URL=https://ä½ çš„åŸŸå.com/api/payment/wechat/notify

# æ”¯ä»˜å®é…ç½®
ALIPAY_APP_ID=ä½ çš„æ”¯ä»˜å®AppID
ALIPAY_PRIVATE_KEY=ä½ çš„åº”ç”¨ç§é’¥
ALIPAY_PUBLIC_KEY=æ”¯ä»˜å®å…¬é’¥
ALIPAY_NOTIFY_URL=https://ä½ çš„åŸŸå.com/api/payment/alipay/notify
```

### æ–¹æ³•2ï¼šç›´æ¥ä¿®æ”¹ä»£ç ï¼ˆä¸æ¨èï¼‰

ä¿®æ”¹ `services/payment.js` æ–‡ä»¶ä¸­çš„ `PAYMENT_CONFIG` å¯¹è±¡ï¼ˆç¬¬5-18è¡Œï¼‰ã€‚

---

## ğŸ“± å¾®ä¿¡æ”¯ä»˜é…ç½®

### 1. ç”³è¯·å¾®ä¿¡æ”¯ä»˜å•†æˆ·å·

è®¿é—®ï¼šhttps://pay.weixin.qq.com/

1. **æ³¨å†Œè´¦å·**
   - å‡†å¤‡è¥ä¸šæ‰§ç…§
   - å¡«å†™å•†æˆ·ä¿¡æ¯
   - ç­‰å¾…å®¡æ ¸ï¼ˆé€šå¸¸1-3ä¸ªå·¥ä½œæ—¥ï¼‰

2. **è·å–é…ç½®ä¿¡æ¯**
   å®¡æ ¸é€šè¿‡åï¼Œåœ¨å¾®ä¿¡æ”¯ä»˜å•†æˆ·å¹³å°è·å–ï¼š
   - **AppID**ï¼ˆåº”ç”¨IDï¼‰
   - **å•†æˆ·å·ï¼ˆMchIDï¼‰**
   - **APIå¯†é’¥ï¼ˆAPIKeyï¼‰**

3. **é…ç½®å›è°ƒåœ°å€**
   åœ¨å•†æˆ·å¹³å°è®¾ç½®æ”¯ä»˜å›è°ƒURLï¼š
   ```
   https://ä½ çš„åŸŸå.com/api/payment/wechat/notify
   ```

### 2. è·å–å¾®ä¿¡æ”¯ä»˜å‚æ•°

ç™»å½•å¾®ä¿¡æ”¯ä»˜å•†æˆ·å¹³å°ï¼š

```
è´¦æˆ·ä¸­å¿ƒ -> APIå®‰å…¨ -> è®¾ç½®APIå¯†é’¥
```

#### ç¤ºä¾‹é…ç½®
```bash
WECHAT_APP_ID=wx1234567890abcdef
WECHAT_MCH_ID=1234567890
WECHAT_API_KEY=abcdef1234567890abcdef1234567890
WECHAT_NOTIFY_URL=https://autoanki.example.com/api/payment/wechat/notify
```

### 3. é›†æˆå¾®ä¿¡æ”¯ä»˜SDKï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦æ›´å®Œæ•´çš„åŠŸèƒ½ï¼Œå¯ä»¥å®‰è£…å¾®ä¿¡æ”¯ä»˜SDKï¼š

```bash
npm install wechatpay-node-v3
```

ç„¶åä¿®æ”¹ `services/payment.js` ä¸­çš„ `wechatPay.createOrder` æ–¹æ³•ï¼š

```javascript
const { Payment } = require('wechatpay-node-v3');

const payment = new Payment({
    appid: PAYMENT_CONFIG.wechat.appId,
    mchid: PAYMENT_CONFIG.wechat.mchId,
    private_key: 'ä½ çš„ç§é’¥',
    serial_no: 'è¯ä¹¦åºåˆ—å·'
});

// åœ¨ createOrder æ–¹æ³•ä¸­
const result = await payment.native({
    description: 'å……å€¼ç§¯åˆ†',
    out_trade_no: orderNo,
    notify_url: PAYMENT_CONFIG.wechat.notifyUrl,
    amount: {
        total: Math.floor(amount * 100) // è½¬ä¸ºåˆ†
    }
});

// result.code_url å°±æ˜¯äºŒç»´ç é“¾æ¥
```

---

## ğŸ’³ æ”¯ä»˜å®é…ç½®

### 1. ç”³è¯·æ”¯ä»˜å®å•†æˆ·è´¦å·

è®¿é—®ï¼šhttps://open.alipay.com/

1. **æ³¨å†Œå¼€å‘è€…è´¦å·**
2. **åˆ›å»ºåº”ç”¨**
   - é€‰æ‹©"ç½‘é¡µ/ç§»åŠ¨åº”ç”¨"
   - å¡«å†™åº”ç”¨ä¿¡æ¯
   - æäº¤å®¡æ ¸

3. **ç­¾çº¦äº§å“**
   åœ¨åº”ç”¨ç®¡ç†ä¸­ç­¾çº¦ï¼š
   - **æ‰‹æœºç½‘ç«™æ”¯ä»˜**
   - **å½“é¢ä»˜ï¼ˆæ‰«ç æ”¯ä»˜ï¼‰**

### 2. é…ç½®å¯†é’¥

#### ç”Ÿæˆåº”ç”¨å¯†é’¥

æ”¯ä»˜å®ä½¿ç”¨RSA2åŠ å¯†ï¼Œéœ€è¦ç”Ÿæˆå¯†é’¥å¯¹ï¼š

**æ–¹æ³•Aï¼šä½¿ç”¨æ”¯ä»˜å®å·¥å…·**
1. ä¸‹è½½"æ”¯ä»˜å®å¼€æ”¾å¹³å°å¼€å‘åŠ©æ‰‹"
2. ç”ŸæˆRSA2å¯†é’¥å¯¹
3. ä¸Šä¼ å…¬é’¥åˆ°æ”¯ä»˜å®å¼€æ”¾å¹³å°

**æ–¹æ³•Bï¼šä½¿ç”¨OpenSSL**
```bash
# ç”Ÿæˆç§é’¥
openssl genrsa -out app_private_key.pem 2048

# ç”Ÿæˆå…¬é’¥
openssl rsa -in app_private_key.pem -pubout -out app_public_key.pem
```

#### é…ç½®åˆ°é¡¹ç›®

```bash
ALIPAY_APP_ID=2021001234567890
ALIPAY_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----
ä½ çš„åº”ç”¨ç§é’¥å†…å®¹
-----END PRIVATE KEY-----"
ALIPAY_PUBLIC_KEY="-----BEGIN PUBLIC KEY-----
æ”¯ä»˜å®å…¬é’¥å†…å®¹ï¼ˆä»å¼€æ”¾å¹³å°è·å–ï¼‰
-----END PUBLIC KEY-----"
ALIPAY_NOTIFY_URL=https://autoanki.example.com/api/payment/alipay/notify
```

### 3. é›†æˆæ”¯ä»˜å®SDK

å®‰è£…æ”¯ä»˜å®SDKï¼š

```bash
npm install alipay-sdk
```

ä¿®æ”¹ `services/payment.js`ï¼š

```javascript
const AlipaySdk = require('alipay-sdk').default;

const alipaySdk = new AlipaySdk({
    appId: PAYMENT_CONFIG.alipay.appId,
    privateKey: PAYMENT_CONFIG.alipay.privateKey,
    alipayPublicKey: PAYMENT_CONFIG.alipay.alipayPublicKey,
    gateway: 'https://openapi.alipay.com/gateway.do'
});

// åœ¨ createOrder æ–¹æ³•ä¸­
const result = await alipaySdk.exec('alipay.trade.precreate', {
    notify_url: PAYMENT_CONFIG.alipay.notifyUrl,
    biz_content: {
        out_trade_no: orderNo,
        total_amount: amount.toFixed(2),
        subject: 'å……å€¼ç§¯åˆ†',
        qr_code_timeout_express: '15m'
    }
});

// result.qr_code å°±æ˜¯äºŒç»´ç é“¾æ¥
```

---

## ğŸ§ª æµ‹è¯•æ¨¡å¼

åœ¨å¼€å‘é˜¶æ®µï¼Œå¯ä»¥ä½¿ç”¨æ¨¡æ‹Ÿæ”¯ä»˜åŠŸèƒ½è¿›è¡Œæµ‹è¯•ã€‚

### ä½¿ç”¨æ¨¡æ‹Ÿæ”¯ä»˜API

```bash
# åˆ›å»ºè®¢å•
POST /api/payment/create-order
{
    "amount": 10,
    "method": "mock"
}

# æ¨¡æ‹Ÿæ”¯ä»˜å®Œæˆ
POST /api/payment/mock-pay
{
    "orderNo": "è®¢å•å·"
}
```

### å‰ç«¯æµ‹è¯•

åœ¨ç”¨æˆ·ä¸­å¿ƒå……å€¼é¡µé¢é€‰æ‹©é‡‘é¢åï¼Œç³»ç»Ÿä¼šï¼š
1. åˆ›å»ºè®¢å•
2. æ˜¾ç¤ºäºŒç»´ç ï¼ˆæ¨¡æ‹Ÿï¼‰
3. å¯ä»¥æ‰‹åŠ¨è°ƒç”¨ mock-pay API å®Œæˆæ”¯ä»˜

---

## ğŸ“‹ å›è°ƒæ¥å£è¯´æ˜

### å¾®ä¿¡æ”¯ä»˜å›è°ƒ

**æ¥å£åœ°å€**ï¼š`POST /api/payment/wechat/notify`

**å‚æ•°**ï¼šå¾®ä¿¡ä¼šPOST XMLæ•°æ®

**è¿”å›**ï¼š
```xml
<xml>
  <return_code><![CDATA[SUCCESS]]></return_code>
  <return_msg><![CDATA[OK]]></return_msg>
</xml>
```

### æ”¯ä»˜å®å›è°ƒ

**æ¥å£åœ°å€**ï¼š`POST /api/payment/alipay/notify`

**å‚æ•°**ï¼šè¡¨å•å½¢å¼POST

**è¿”å›**ï¼š
```
success
```

### å›è°ƒå¤„ç†æµç¨‹

å½“ç”¨æˆ·å®Œæˆæ”¯ä»˜åï¼š
1. æ”¯ä»˜å¹³å°è°ƒç”¨å›è°ƒæ¥å£
2. éªŒè¯ç­¾å
3. æŸ¥æ‰¾è®¢å•
4. æ›´æ–°è®¢å•çŠ¶æ€
5. ç»™ç”¨æˆ·å……å€¼ç§¯åˆ†
6. è¿”å›æˆåŠŸå“åº”

---

## ğŸ”’ å®‰å…¨å»ºè®®

### 1. ä¿æŠ¤å¯†é’¥å®‰å…¨

```bash
# ä¸è¦å°†å¯†é’¥æäº¤åˆ° git
echo ".env" >> .gitignore

# è®¾ç½®æ–‡ä»¶æƒé™
chmod 600 .env
```

### 2. éªŒè¯å›è°ƒç­¾å

åœ¨ `services/payment.js` ä¸­å®ç°ç­¾åéªŒè¯ï¼š

```javascript
// å¾®ä¿¡æ”¯ä»˜ç­¾åéªŒè¯
verifyNotify: (params) => {
    const { sign, ...data } = params;
    const str = Object.keys(data)
        .sort()
        .map(key => `${key}=${data[key]}`)
        .join('&') + `&key=${PAYMENT_CONFIG.wechat.apiKey}`;
    
    const hash = crypto.createHash('md5').update(str).digest('hex').toUpperCase();
    return hash === sign;
}
```

### 3. é˜²æ­¢é‡å¤é€šçŸ¥

```javascript
// æ£€æŸ¥è®¢å•çŠ¶æ€
if (order.status === 'paid') {
    return { success: true, message: 'è®¢å•å·²å¤„ç†' };
}
```

### 4. ä½¿ç”¨HTTPS

æ”¯ä»˜å›è°ƒå¿…é¡»ä½¿ç”¨HTTPSï¼Œç”³è¯·SSLè¯ä¹¦ï¼š
- Let's Encryptï¼ˆå…è´¹ï¼‰
- é˜¿é‡Œäº‘SSL
- è…¾è®¯äº‘SSL

---

## ğŸš€ ä¸Šçº¿éƒ¨ç½²

### 1. é…ç½®åŸŸå

è´­ä¹°åŸŸåå¹¶è§£æåˆ°æœåŠ¡å™¨ï¼š
```
A è®°å½•: autoanki.example.com -> ä½ çš„æœåŠ¡å™¨IP
```

### 2. é…ç½®Nginxåå‘ä»£ç†

```nginx
server {
    listen 443 ssl http2;
    server_name autoanki.example.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    location /api/payment/ {
        proxy_pass http://localhost:3000/api/payment/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 3. æ›´æ–°å›è°ƒURL

åœ¨å¾®ä¿¡æ”¯ä»˜å’Œæ”¯ä»˜å®å•†æˆ·å¹³å°æ›´æ–°å›è°ƒURLï¼š
```
https://autoanki.example.com/api/payment/wechat/notify
https://autoanki.example.com/api/payment/alipay/notify
```

### 4. æµ‹è¯•æ”¯ä»˜æµç¨‹

1. åœ¨ç”Ÿäº§ç¯å¢ƒåˆ›å»ºå°é¢è®¢å•ï¼ˆ0.01å…ƒï¼‰
2. ä½¿ç”¨æ‰‹æœºæ‰«ç æ”¯ä»˜
3. æ£€æŸ¥è®¢å•çŠ¶æ€æ˜¯å¦æ›´æ–°
4. æ£€æŸ¥ç§¯åˆ†æ˜¯å¦åˆ°è´¦
5. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ç¡®è®¤å›è°ƒæˆåŠŸ

---

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### æŸ¥çœ‹æ”¯ä»˜æ—¥å¿—

```bash
# æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
tail -f /tmp/autoanki.log | grep payment

# æŸ¥çœ‹æ•°æ®åº“è®¢å•
sqlite3 database/autoanki.db "
SELECT 
    order_no,
    amount,
    credits,
    status,
    payment_method,
    datetime(created_at, 'localtime') as time
FROM orders 
ORDER BY created_at DESC 
LIMIT 10;
"
```

### è®¢å•çŠ¶æ€è¯´æ˜

- `pending` - å¾…æ”¯ä»˜
- `paid` - å·²æ”¯ä»˜
- `failed` - æ”¯ä»˜å¤±è´¥
- `refunded` - å·²é€€æ¬¾

---

## â“ å¸¸è§é—®é¢˜

### Q1: å›è°ƒæ¥å£æ”¶ä¸åˆ°é€šçŸ¥ï¼Ÿ

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] å›è°ƒURLæ˜¯å¦é…ç½®æ­£ç¡®
- [ ] æ˜¯å¦ä½¿ç”¨HTTPS
- [ ] æœåŠ¡å™¨é˜²ç«å¢™æ˜¯å¦å¼€æ”¾
- [ ] Nginxé…ç½®æ˜¯å¦æ­£ç¡®
- [ ] åŸŸåæ˜¯å¦æ­£ç¡®è§£æ

### Q2: ç­¾åéªŒè¯å¤±è´¥ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤APIå¯†é’¥æ­£ç¡®
2. æ£€æŸ¥å‚æ•°æ’åºæ˜¯å¦æ­£ç¡®
3. ç¡®è®¤ç¼–ç æ ¼å¼ï¼ˆUTF-8ï¼‰
4. æŸ¥çœ‹æ”¯ä»˜å¹³å°é”™è¯¯æ—¥å¿—

### Q3: æµ‹è¯•ç¯å¢ƒå¦‚ä½•ä½¿ç”¨ï¼Ÿ

æ”¯ä»˜å®æä¾›æ²™ç®±ç¯å¢ƒï¼š
```bash
ALIPAY_GATEWAY=https://openapi.alipaydev.com/gateway.do
```

å¾®ä¿¡æ”¯ä»˜éœ€è¦ç”³è¯·æµ‹è¯•å•†æˆ·å·ã€‚

### Q4: å¦‚ä½•å¤„ç†é€€æ¬¾ï¼Ÿ

åœ¨ `services/payment.js` ä¸­æ·»åŠ é€€æ¬¾æ–¹æ³•ï¼š

```javascript
refund: async (orderNo, amount) => {
    // è°ƒç”¨æ”¯ä»˜å¹³å°é€€æ¬¾API
    // æ›´æ–°è®¢å•çŠ¶æ€
    // æ‰£é™¤ç”¨æˆ·ç§¯åˆ†
}
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

### å®˜æ–¹æ–‡æ¡£
- [å¾®ä¿¡æ”¯ä»˜å¼€å‘æ–‡æ¡£](https://pay.weixin.qq.com/wiki/doc/api/index.html)
- [æ”¯ä»˜å®å¼€æ”¾å¹³å°](https://opendocs.alipay.com/)

### SDKæ–‡æ¡£
- [wechatpay-node-v3](https://github.com/wechatpay-apiv3/wechatpay-node-v3)
- [alipay-sdk](https://github.com/alipay/alipay-sdk-nodejs-all)

### å·¥å…·ä¸‹è½½
- [æ”¯ä»˜å®å¼€æ”¾å¹³å°å¼€å‘åŠ©æ‰‹](https://opendocs.alipay.com/common/02kipk)
- [å¾®ä¿¡æ”¯ä»˜å•†æˆ·å¹³å°è¯ä¹¦å·¥å…·](https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=4_3)

---

## âœ… å¿«é€Ÿæ£€æŸ¥æ¸…å•

### é…ç½®å®Œæˆæ£€æŸ¥

- [ ] å¾®ä¿¡AppIDå·²é…ç½®
- [ ] å¾®ä¿¡å•†æˆ·å·å·²é…ç½®
- [ ] å¾®ä¿¡APIå¯†é’¥å·²é…ç½®
- [ ] å¾®ä¿¡å›è°ƒURLå·²é…ç½®
- [ ] æ”¯ä»˜å®AppIDå·²é…ç½®
- [ ] æ”¯ä»˜å®åº”ç”¨ç§é’¥å·²é…ç½®
- [ ] æ”¯ä»˜å®å…¬é’¥å·²é…ç½®
- [ ] æ”¯ä»˜å®å›è°ƒURLå·²é…ç½®
- [ ] åŸŸåå·²è§£æ
- [ ] SSLè¯ä¹¦å·²å®‰è£…
- [ ] Nginxé…ç½®å®Œæˆ
- [ ] å›è°ƒæ¥å£æµ‹è¯•é€šè¿‡

---

**é…ç½®å®Œæˆåï¼Œé‡å¯æœåŠ¡å™¨ä½¿é…ç½®ç”Ÿæ•ˆï¼š**

```bash
npm start
```

**ç¥æ‚¨é…ç½®é¡ºåˆ©ï¼å¦‚æœ‰é—®é¢˜è¯·æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚** ğŸ’ª


