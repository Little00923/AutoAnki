<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•å·¥å…· - AutoAnki</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        h2 { color: #333; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>ğŸ”§ AutoAnki è°ƒè¯•å·¥å…·</h1>
    
    <div class="section">
        <h2>1. æ£€æŸ¥ç™»å½•çŠ¶æ€</h2>
        <button onclick="checkAuth()">æ£€æŸ¥è®¤è¯</button>
        <button onclick="clearToken()">æ¸…é™¤Token</button>
        <pre id="authResult"></pre>
    </div>
    
    <div class="section">
        <h2>2. æµ‹è¯•API</h2>
        <button onclick="testConfig()">æµ‹è¯•é…ç½®API</button>
        <button onclick="testAuthMe()">æµ‹è¯•ç”¨æˆ·API</button>
        <pre id="apiResult"></pre>
    </div>
    
    <div class="section">
        <h2>3. æ£€æŸ¥é¦–é¡µå…ƒç´ </h2>
        <button onclick="checkIndexPage()">æ£€æŸ¥é¦–é¡µDOM</button>
        <pre id="domResult"></pre>
    </div>
    
    <div class="section">
        <h2>4. å¯¼èˆªæµ‹è¯•</h2>
        <button onclick="goToIndex()">è·³è½¬é¦–é¡µ</button>
        <button onclick="goToUserCenter()">è·³è½¬ç”¨æˆ·ä¸­å¿ƒ</button>
        <button onclick="goToAuth()">è·³è½¬ç™»å½•é¡µ</button>
    </div>
    
    <div class="section">
        <h2>5. localStorage çŠ¶æ€</h2>
        <button onclick="checkStorage()">æŸ¥çœ‹å­˜å‚¨</button>
        <button onclick="clearStorage()">æ¸…é™¤æ‰€æœ‰å­˜å‚¨</button>
        <pre id="storageResult"></pre>
    </div>

    <script>
        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        async function checkAuth() {
            const result = document.getElementById('authResult');
            const token = localStorage.getItem('token');
            
            result.textContent = 'æ£€æŸ¥ä¸­...\n\n';
            result.textContent += '=== Token çŠ¶æ€ ===\n';
            
            if (!token) {
                result.textContent += 'âŒ æœªç™»å½•ï¼ˆæ— tokenï¼‰\n';
                return;
            }
            
            result.textContent += 'âœ“ å·²ç™»å½•\n';
            result.textContent += 'Token å‰20å­—ç¬¦: ' + token.substring(0, 20) + '...\n';
            result.textContent += 'Token é•¿åº¦: ' + token.length + '\n\n';
            
            // è§£æ token
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                result.textContent += '=== Token å†…å®¹ ===\n';
                result.textContent += JSON.stringify(payload, null, 2) + '\n\n';
                
                // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
                const exp = payload.exp * 1000;
                const now = Date.now();
                if (exp < now) {
                    result.textContent += 'âŒ Token å·²è¿‡æœŸ\n';
                } else {
                    result.textContent += 'âœ“ Token æœ‰æ•ˆï¼ˆè¿˜æœ‰ ' + Math.floor((exp - now) / 1000 / 60 / 60) + ' å°æ—¶ï¼‰\n';
                }
            } catch (e) {
                result.textContent += 'âŒ Token æ ¼å¼é”™è¯¯: ' + e.message + '\n';
            }
        }
        
        function clearToken() {
            localStorage.removeItem('token');
            document.getElementById('authResult').textContent = 'âœ“ Token å·²æ¸…é™¤';
        }
        
        // æµ‹è¯•é…ç½®API
        async function testConfig() {
            const result = document.getElementById('apiResult');
            result.textContent = 'æµ‹è¯•é…ç½®API...\n\n';
            
            try {
                const response = await fetch('/api/config');
                result.textContent += 'HTTP çŠ¶æ€: ' + response.status + '\n';
                const data = await response.json();
                result.textContent += 'API å“åº”:\n' + JSON.stringify(data, null, 2);
            } catch (error) {
                result.textContent += 'âŒ é”™è¯¯: ' + error.message;
            }
        }
        
        // æµ‹è¯•ç”¨æˆ·API
        async function testAuthMe() {
            const result = document.getElementById('apiResult');
            const token = localStorage.getItem('token');
            
            if (!token) {
                result.textContent = 'âŒ æœªç™»å½•ï¼Œæ— æ³•æµ‹è¯•';
                return;
            }
            
            result.textContent = 'æµ‹è¯•ç”¨æˆ·API...\n\n';
            
            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });
                result.textContent += 'HTTP çŠ¶æ€: ' + response.status + '\n';
                const data = await response.json();
                result.textContent += 'API å“åº”:\n' + JSON.stringify(data, null, 2);
            } catch (error) {
                result.textContent += 'âŒ é”™è¯¯: ' + error.message;
            }
        }
        
        // æ£€æŸ¥é¦–é¡µDOM
        function checkIndexPage() {
            const result = document.getElementById('domResult');
            result.textContent = 'æ­£åœ¨æ£€æŸ¥é¦–é¡µå…ƒç´ ...\n\n';
            
            // ä½¿ç”¨ iframe åŠ è½½é¦–é¡µ
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = './';
            document.body.appendChild(iframe);
            
            iframe.onload = function() {
                const doc = iframe.contentDocument;
                const elements = [
                    'inputPage', 'previewPage', 'materialInput', 'cardCount',
                    'generateBtn', 'exportBtn', 'backBtn', 'cardsContainer',
                    'pagination', 'statusText', 'loadingOverlay',
                    'navGuest', 'navUser', 'navUserCredits', 'guestTrialRemaining'
                ];
                
                result.textContent += '=== DOM å…ƒç´ æ£€æŸ¥ ===\n';
                elements.forEach(id => {
                    const el = doc.getElementById(id);
                    if (el) {
                        result.textContent += 'âœ“ ' + id + '\n';
                    } else {
                        result.textContent += 'âŒ ' + id + ' (ç¼ºå¤±)\n';
                    }
                });
                
                result.textContent += '\n=== è„šæœ¬æ ‡ç­¾ ===\n';
                const scripts = doc.getElementsByTagName('script');
                for (let script of scripts) {
                    result.textContent += '- ' + (script.src || '(inline)') + '\n';
                }
                
                document.body.removeChild(iframe);
            };
            
            iframe.onerror = function() {
                result.textContent += 'âŒ æ— æ³•åŠ è½½é¦–é¡µ';
                document.body.removeChild(iframe);
            };
        }
        
        // æ£€æŸ¥å­˜å‚¨
        function checkStorage() {
            const result = document.getElementById('storageResult');
            result.textContent = '=== localStorage ===\n';
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                let value = localStorage.getItem(key);
                
                // å¯¹äº tokenï¼Œåªæ˜¾ç¤ºå‰åéƒ¨åˆ†
                if (key === 'token' && value.length > 40) {
                    value = value.substring(0, 20) + '...' + value.substring(value.length - 10);
                }
                
                result.textContent += key + ': ' + value + '\n';
            }
            
            if (localStorage.length === 0) {
                result.textContent += '(ç©º)\n';
            }
        }
        
        function clearStorage() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ localStorage æ•°æ®å—ï¼Ÿ')) {
                localStorage.clear();
                document.getElementById('storageResult').textContent = 'âœ“ å·²æ¸…é™¤æ‰€æœ‰å­˜å‚¨';
            }
        }
        
        // å¯¼èˆª
        function goToIndex() {
            window.location.href = './';
        }
        
        function goToUserCenter() {
            window.location.href = 'user-center.html';
        }
        
        function goToAuth() {
            window.location.href = 'auth.html';
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            checkStorage();
        });
    </script>
    <script src="i18n.js"></script>
</body>
</html>


